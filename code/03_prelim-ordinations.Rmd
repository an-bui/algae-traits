---
title: "ordinations"
author: "An Bui"
date: "10/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# source the cleaning/summarizing script, which sources the set up
source(here::here("code", "01a_trait-cleaning.R"))
```

# 0. Orientation

Necessary data frames are `tbs_matrix` created in the set up script.     

# 1. trait PCoA

```{r}
gower_mat <- ind_traits %>% 
  filter(sp_code %in% algae_proposal) %>% 
  # filter(!(sp_code %in% c("CO"))) %>% 
  filter(!(specimen_ID %in% recruits)) %>% 
  # weird Nienburgia?
  filter(!(specimen_ID == "20210721-BULL-023")) %>% 
  # take out standard error
  dplyr::select(!ends_with("_se")) %>% 
  # take out irrelevant columns
  dplyr::select(-c(sp_code, scientific_name, life_habit, posture, branching_yn, lifestage, method, year)) %>% 
  # take out date selected and site
  dplyr::select(-c(date_collected, site)) %>% 
  column_to_rownames("specimen_ID") %>% 
  # convert categorical traits into factors
  mutate(growth_form = as_factor(growth_form),
         pigment_type = as_factor(pigment_type),
         longevity = as_factor(longevity))

# note: PCOA is based on distance matrices, so never actually sees "species"
# add species by calculating weighted averages: from original data matrix of traits by species, average abundance and axis scores for all sites
tbs_gower <- FD::gowdis(gower_mat)
tbs_pcoa <- cmdscale(tbs_gower, eig = TRUE)
ordiplot(tbs_pcoa, display = "sites", type = "text")

tbs_gower_daisy <- daisy(gower_mat, metric = "gower") # same as above
tbs_pcoa_daisy <- cmdscale(tbs_gower_daisy, eig = TRUE)
ordiplot(tbs_pcoa_daisy, display = "sites", type = "text")
biplot.pcoa(ape::pcoa(tbs_gower_daisy))
test_pcoa <- ape::pcoa(tbs_gower_daisy, correction = "lingoes") 
test_pcoa

# tbs_pcoa <- wcmdscale(tbs_gower, eig = TRUE)
# tbs_pcoa <- ape::pcoa(tbs_gower, correction = "none")
# biplot(ape::pcoa(tbs_gower, correction = "none"))
# ordiplot(scores(tbs_pcoa, choices=c(1,2)), type="none", main="PCoA with species weighted averages")
# tbs.wa <- wascores(tbs_pcoa$points[,1:2], tbs_matrix)
# text(tbs.wa, rownames(tbs.wa), cex=0.7, col="red")
# biplot.pcoa(tbs_gower, tbs_pcoa, dir.axis1 = -1)
# tbs_pcoa$species <- wascores(x = tbs_pcoa$points, , expand = TRUE)
p1 <- ordiplot(tbs_pcoa, display = "sites", type = "none")
points1 <- points(p1, "sites", pch = 21, col = "red", bg = "yellow")
text(p1, "sites", col = "blue", cex = 0.9)
# identify(p1, "sites")



pcoa_spp_scores <- scores(tbs_pcoa, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("specimen_ID") %>% 
  left_join(., metadata_ind, by = "specimen_ID")

pcoa_trait_scores <- scores(tbs_pcoa, choices = c(1,2)) %>% 
  as.data.frame()
ggplot(pcoa_spp_scores, aes(x = Dim1, y = Dim2, color = sp_code, shape = site)) +
  geom_hline(yintercept = 0, color = "grey", lty = 3) +
  geom_vline(xintercept = 0, color = "grey", lty = 3) +
  geom_point(alpha = 0.8, size = 3) +
  theme_bw()
```

# 2. PCA

```{r}
# sp_int_matrix <- ind_traits %>% 
#   filter(sp_code %in% algae_proposal) %>% 
#   filter(!(sp_code %in% c("CO"))) %>% 
#   # weird Nienburgia?
#   filter(!(specimen_ID == "20210721-BULL-023"))

pca_mat <- ind_traits %>% 
  filter(sp_code %in% algae_proposal) %>% 
  # filter(!(sp_code %in% c("CO"))) %>% 
  # filter(!(sp_code == "PTCA" & lifestage == "recruit")) %>% 
  # weird Nienburgia?
  filter(!(specimen_ID %in% c("20210721-BULL-023", "20210719-IVEE-009"))) %>% 
  mutate(growth_form_num = case_when(
    growth_form == "leathery_macrophyte" ~ 1,
    growth_form == "corticated_macrophytes" ~ 2,
    growth_form == "corticated_foliose" ~ 3
  ), 
  pigment_type_num = case_when(
    pigment_type == "red" ~ 1,
    pigment_type == "brown" ~ 2
  ), 
  longevity_num = case_when(
    longevity == "annual" ~ 1,
    longevity == "perennial" ~ 3,
    longevity == "annual or perennial" ~ 2
  )) %>% 
  dplyr::select(specimen_ID, maximum_height, total_volume, sav_mean, thickness_mm_mean, tdmc_mean, sta_mean, sav_mean, sap_mean, fvfm_mean, thickness_mm_mean) %>% 
  column_to_rownames("specimen_ID") %>% 
  drop_na()

pca_mat_with_cn <- ind_traits %>% 
  filter(sp_code %in% algae_proposal) %>% 
  # filter(!(sp_code %in% c("CO"))) %>% 
  # filter(!(sp_code == "PTCA" & lifestage == "recruit")) %>% 
  # weird Nienburgia?
  filter(!(specimen_ID %in% c("20210721-BULL-023", "20210719-IVEE-009"))) %>% 
  mutate(growth_form_num = case_when(
    growth_form == "leathery_macrophyte" ~ 1,
    growth_form == "corticated_macrophytes" ~ 2,
    growth_form == "corticated_foliose" ~ 3
  ), 
  pigment_type_num = case_when(
    pigment_type == "red" ~ 1,
    pigment_type == "brown" ~ 2
  ), 
  longevity_num = case_when(
    longevity == "annual" ~ 1,
    longevity == "perennial" ~ 3,
    longevity == "annual or perennial" ~ 2
  )) %>% 
  dplyr::select(specimen_ID, maximum_height, total_volume, sav_mean, thickness_mm_mean, tdmc_mean, sta_mean, sav_mean, sap_mean, fvfm_mean, thickness_mm_mean, weight_percent_n_mean, weight_percent_c_mean) %>% 
  column_to_rownames("specimen_ID") %>% 
  drop_na()

# , growth_form_num, pigment_type_num, longevity_num 
# frond_length_mean, frond_width_mean
```

Got a lot of help from David Zeleny's [blog post](https://www.davidzeleny.net/anadat-r/doku.php/en:pca_examples).

```{r}
# tbs matrix filtered for species in proposal
# doesn't include Nienburgia or Corallina
# sp_int_matrix <- tbs_matrix %>% 
#   filter(sp_code %in% algae_proposal) %>% 
#   filter(!(sp_code %in% c("CO", "Nandersoniana")))
# 
# filtered_matrix <- tbs_matrix %>% 
#   filter(!(sp_code %in% c("MAPY", "CO", "Nandersoniana")))

# matrix_choice <- pca_mat

# only include numeric variables
# tbs_pca <- rda(matrix_choice[, 2:10], scale = TRUE)
tbs_pca <- rda(pca_mat, scale = TRUE)
screeplot(tbs_pca, bstick = TRUE)

# extract proportion explained for each axis
summary(tbs_pca)
loadings <- scores(tbs_pca, display = 'species', scaling = 0, choices = c(1, 2, 3))

# extract correlation of variables with PC1
sort(abs(loadings[,1]), decreasing = TRUE)
# extract correlation of variables with PC2
sort(abs(loadings[,2]), decreasing = TRUE)

# simple biplot (compare with ggplot output to make sure it's right)
biplot(tbs_pca)

# species points
PCAscores <- scores(tbs_pca, display = "sites", choices = c(1, 2)) %>% 
  as.data.frame() %>% 
  rownames_to_column("specimen_ID") %>% 
  left_join(metadata_ind, by = "specimen_ID") %>% 
  left_join(., coarse_traits, by = "sp_code") %>% 
  mutate(scientific_name = factor(scientific_name, levels = algae_proposal_sciname_factors))

PCAscores_13 <- scores(tbs_pca, display = "sites", choices = c(1, 3)) %>% 
  as.data.frame() %>% 
  rownames_to_column("specimen_ID") %>% 
  left_join(metadata_ind, by = "specimen_ID") %>% 
  left_join(., coarse_traits, by = "sp_code") %>% 
  mutate(scientific_name = factor(scientific_name, levels = algae_proposal_sciname_factors))

# trait vectors
PCAvect <- scores(tbs_pca, display = "species", choices = c(1, 2)) %>% 
  as.data.frame()

PCAvect_13 <- scores(tbs_pca, display = "species", choices = c(1, 3)) %>% 
  as.data.frame()

# plot PCA
plot_PCA_12 <- ggplot() +
  coord_cartesian() +
  geom_vline(xintercept = c(0), color = "grey70", linetype = 2) +
  geom_hline(yintercept = c(0), color = "grey70", linetype = 2) +
  geom_point(data = PCAscores, aes(x = PC1, y = PC2, color = scientific_name), size = 4) +
  # geom_text(data = PCAscores, aes(x = PC1, y = PC2, color = scientific_name, label = specimen_ID)) +
  scale_color_manual(values = algae_colors) +
  geom_segment(data = PCAvect, aes(x = 0, y = 0, xend = PC1, yend = PC2), arrow = arrow(length = unit(0.2, "cm")), linewidth = 1) +
  geom_text(data = PCAvect, aes(x = PC1, y = PC2, label = rownames(PCAvect)), size = 5, alpha = 0.8) +
  # scale_x_continuous(limits = c(-1.75, 3.75)) +
  # scale_y_continuous(limits = c(-2, 3.25)) +
  theme_bw() +
  guides(colour = guide_legend(ncol = 1),
         shape = guide_legend(ncol = 1)) +
  theme(legend.position = "right", 
        # legend.box = "", 
        legend.margin = margin(),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        title = element_text(size = 20),
        legend.text = element_text(size = 12)) +
  labs(x = "PC1 (27%)",
       y = "PC2 (25%)",
       title = "PC1 and PC2",
       color = "Scientific name") 
plot_PCA_12

plot_PCA_13 <- ggplot() +
  coord_cartesian() +
  geom_vline(xintercept = c(0), color = "grey70", linetype = 2) +
  geom_hline(yintercept = c(0), color = "grey70", linetype = 2) +
  geom_point(data = PCAscores_13, aes(x = PC1, y = PC3, color = scientific_name, shape = site), size = 4) +
  # geom_text(data = PCAscores, aes(x = PC1, y = PC2, color = scientific_name, label = specimen_ID)) +
  scale_color_manual(values = algae_colors) +

  geom_segment(data = PCAvect_13, aes(x = 0, y = 0, xend = PC1, yend = PC3), arrow = arrow(length = unit(0.2, "cm")), linewidth = 1) +
  geom_text(data = PCAvect_13, aes(x = PC1, y = PC3, label = rownames(PCAvect)), size = 5, alpha = 0.8) +
  # scale_x_continuous(limits = c(-1.5, 2.3)) +
  # scale_y_continuous(limits = c(-3, 2)) +
  theme_bw() +
  guides(colour = guide_legend(ncol = 2),
         shape = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom", 
        legend.box = "vertical", 
        legend.margin = margin(),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        title = element_text(size = 20),
        legend.text = element_text(size = 12)) +
  labs(x = "PC1 (27%)",
       y = "PC3 (12%)",
       title = "PC1 and PC3",
       color = "Scientific name") 
plot_PCA_13

pca_together <- (plot_PCA_12 | plot_PCA_13) +
  plot_layout(guides = "collect", ncol = 2, widths = c(1, 1)) &
  theme(legend.position = "bottom")
pca_together

# get loading contributions
loadings <- scores(tbs_pca, display = 'species', scaling = 0)
sort(abs(loadings[,1]), decreasing = TRUE)
sort(abs(loadings[,2]), decreasing = TRUE)

# ggsave(here::here("figures/prelim-ordinations",
#                   paste("PCA_together_cont-", today(), ".jpg", sep = "")),
#        pca_together,
#        width = 20, height = 12, dpi = 300)
# 
# ggsave(here::here("figures/prelim-ordinations",
#                   paste("PCA_spp-all-12-", today(), ".jpg", sep = "")),
#        plot_PCA_12,
#        width = 16, height = 8, dpi = 150)
# 
# ggsave(here::here("figures/prelim-ordinations",
#                   paste("PCA_spp-all-13-", today(), ".jpg", sep = "")),
#        plot_PCA_13,
#        width = 10, height = 10, dpi = 150)
```

# 3. Corrplot

```{r}
M <- pca_mat %>% 
  cor(method = "spearman")

corr_traits <- corrplot(M, method = "circle", type = "lower", insig = "pch", addCoef.col = "black")
corr_traits

new_corr <- ggcorr(data = pca_mat, 
       method = c("pairwise", "spearman"), 
       label = TRUE, 
       label_alpha = TRUE,
       label_round = 2,
       high = "#3B9AB2",
       low = "#F21A00",
       label_size = 6,
       legend.size = 8,
       size = 6)

new_corr

# ggsave(filename = here("figures", "prelim-ordinations",
#                        paste0("corrplot-traits_square_", today(), ".jpg")),
#        new_corr,
#        width = 12, height = 10, units = "cm",
#        dpi = 150)


```

# 4. PTCA adults vs recruits

```{r}
tbsample_matrix_ptca <- av_leaf_values %>% 
  left_join(., metadata_ind, by = "specimen_ID") %>% 
  filter(sp_code == "PTCA") %>% 
  filter(site %in% c("Arroyo Quemado", "Mohawk")) %>% 
  left_join(., volume_ind, by = "specimen_ID") %>% 
  left_join(., fvfm_ind, by = "specimen_ID") %>% 
  left_join(., ind_height, by = "specimen_ID") %>% 
  dplyr::select(site, lifestage, specimen_ID, thickness_mm_mean, tdmc_mean, total_volume, fvfm_mean, frond_length_mean, frond_width_mean, maximum_height) %>% 
  rename("FvFm" = fvfm_mean,
         "STA" = thickness_mm_mean,
         "TDMC" = tdmc_mean,
         "Volume" = total_volume,
         "Frond length" = frond_length_mean,
         "Frond width" = frond_width_mean,
         "Maximum height" = maximum_height)

tbsample_mat <- av_leaf_values %>% 
  left_join(., metadata_ind, by = "specimen_ID") %>% 
  filter(sp_code == "PTCA") %>% 
  filter(site %in% c("Arroyo Quemado", "Mohawk")) %>% 
  left_join(., volume_ind, by = "specimen_ID") %>% 
  left_join(., fvfm_ind, by = "specimen_ID") %>% 
  left_join(., ind_height, by = "specimen_ID") %>% 
  dplyr::select(specimen_ID, thickness_mm_mean, tdmc_mean, total_volume, fvfm_mean, frond_length_mean, frond_width_mean, maximum_height) %>% 
  rename("FvFm" = fvfm_mean,
         "STA" = thickness_mm_mean,
         "TDMC" = tdmc_mean,
         "Volume" = total_volume,
         "Frond length" = frond_length_mean,
         "Frond width" = frond_width_mean,
         "Maximum height" = maximum_height) %>% 
  column_to_rownames("specimen_ID") %>% 
  drop_na()

tbsample_meta <- tbsample_matrix_ptca %>% 
  select(specimen_ID, lifestage, site) %>% 
  filter(specimen_ID %in% rownames(tbsample_mat))

ptca_pca <- rda(tbsample_mat, scale = TRUE)
summary(ptca_pca)
biplot(ptca_pca)

# species points
PCAscores_12_ptca <- scores(ptca_pca, display = "sites", choices = c(1, 2)) %>% 
  as.data.frame() %>% 
  rownames_to_column("specimen_ID") %>% 
  left_join(., tbsample_meta, by = "specimen_ID")

PCAscores_13_ptca <- scores(tbs_pca, display = "sites", choices = c(1, 3)) %>% 
  as.data.frame() %>% 
  rownames_to_column("specimen_ID") %>% 
  left_join(., tbsample_meta, by = "specimen_ID")

# trait vectors
PCAvect_12_ptca <- scores(ptca_pca, display = "species", choices = c(1, 2)) %>% 
  as.data.frame()

PCAvect_13_ptca <- scores(ptca_pca, display = "species", choices = c(1, 3)) %>% 
  as.data.frame()

# plot PCA
plot_PCA_12_ptca <- ggplot() +
  coord_cartesian() +
  geom_point(data = PCAscores_12_ptca, aes(x = PC1, y = PC2, color = lifestage, shape = site), size = 3, alpha = 0.9) +
  scale_color_manual(values = c("#70601d", "#b59b33")) +
  # geom_text(data = PCAscores, aes(x = PC1, y = PC2, color = scientific_name, label = specimen_ID)) +
  # scale_color_manual(values = pal) +
  geom_vline(xintercept = c(0), color = "grey70", linetype = 2) +
  geom_hline(yintercept = c(0), color = "grey70", linetype = 2) +
  geom_segment(data = PCAvect_12_ptca, aes(x = 0, y = 0, xend = PC1, yend = PC2), arrow = arrow(length = unit(0.2, "cm")), size = 1) +
  geom_text_repel(data = PCAvect_12_ptca, aes(x = PC1, y = PC2, label = rownames(PCAvect_12_ptca)), size = 6, alpha = 0.8) +
  # scale_x_continuous(limits = c(-1, 2.1)) +
  # scale_y_continuous(limits = c(-2.7, 1.6)) +
  theme_bw() +
  guides(colour = guide_legend(ncol = 2),
         shape = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom", 
        legend.box = "vertical", 
        legend.margin = margin(),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        title = element_text(size = 20),
        legend.text = element_text(size = 12),
        legend.key = element_rect(size = 11), 
        panel.grid = element_blank()) +
  labs(x = "PC1 (59.07%)",
       y = "PC2 (19.14%)",
       color = "Life stage") 
plot_PCA_12_ptca

plot_PCA_13 <- ggplot() +
  coord_cartesian() +
  geom_point(data = PCAscores_13, aes(x = PC1, y = PC3, color = scientific_name, shape = site), size = 3, alpha = 0.8) +
  # geom_text(data = PCAscores, aes(x = PC1, y = PC2, color = scientific_name, label = specimen_ID)) +
  # scale_color_manual(values = pal) +
  geom_vline(xintercept = c(0), color = "grey70", linetype = 2) +
  geom_hline(yintercept = c(0), color = "grey70", linetype = 2) +
  geom_segment(data = PCAvect_13, aes(x = 0, y = 0, xend = PC1, yend = PC3), arrow = arrow(length = unit(0.2, "cm")), size = 1) +
  geom_text(data = PCAvect_13, aes(x = PC1, y = PC3, label = rownames(PCAvect)), size = 5, alpha = 0.8) +
  scale_x_continuous(limits = c(-1, 2.1)) +
  scale_y_continuous(limits = c(-2.7, 1.6)) +
  theme_bw() +
  guides(colour = guide_legend(ncol = 2),
         shape = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom", 
        legend.box = "vertical", 
        legend.margin = margin(),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        title = element_text(size = 20),
        legend.text = element_text(size = 12)) +
  labs(x = "PC1 (42.4%)",
       y = "PC3 (12.4%)",
       title = "PC1 and PC3",
       color = "Scientific name") 
plot_PCA_13

pca_together <- (plot_PCA_12 | plot_PCA_13) +
  plot_layout(guides = "collect", ncol = 2, widths = c(1, 1)) &
  theme(legend.position = "bottom")
pca_together
```

# 5. environmental conditions

```{r}
env_mat <- CWM_fixed_filtered %>% 
  dplyr::select(transect_ID, mean_urchins, mean_subs, mean_kelp, mean_umol) %>% 
  column_to_rownames("transect_ID") %>% 
  drop_na()

corrplot(cor(env_mat), method = "circle", type = "lower", insig = "blank", addCoef.col = "black")


env_pca <- rda(env_mat, scale = TRUE)

summary(env_pca)
biplot(env_pca)

PCAscores_12_env <- scores(env_pca, display = "sites", choices = c(1, 2)) %>% 
  as.data.frame() %>% 
  rownames_to_column("transect_ID") %>% 
  left_join(., community_metadata_transect, by = "transect_ID")

PCAvect_12_env <- scores(env_pca, display = "species", choices = c(1, 2)) %>% 
  as.data.frame()

plot_PCA_12_env <- ggplot() +
  coord_cartesian() +
  geom_point(data = PCAscores_12_env, aes(x = PC1, y = PC2, color = site, shape = site), size = 3, alpha = 0.7) +
  # scale_color_manual(values = c("#70601d", "#b59b33")) +
  # geom_text(data = PCAscores, aes(x = PC1, y = PC2, color = scientific_name, label = specimen_ID)) +
  # scale_color_manual(values = pal) +
  geom_vline(xintercept = c(0), color = "grey70", linetype = 2) +
  geom_hline(yintercept = c(0), color = "grey70", linetype = 2) +
  geom_segment(data = PCAvect_12_env, aes(x = 0, y = 0, xend = PC1, yend = PC2), arrow = arrow(length = unit(0.2, "cm")), size = 1) +
  geom_text_repel(data = PCAvect_12_env, aes(x = PC1, y = PC2, label = rownames(PCAvect_12_env)), size = 6, alpha = 0.8) +
  # scale_x_continuous(limits = c(-1, 2.1)) +
  # scale_y_continuous(limits = c(-2.7, 1.6)) +
  theme_bw() +
  guides(colour = guide_legend(ncol = 1),
         shape = guide_legend(ncol = 1)) +
  theme(legend.position = c(0.9, 0.2),
        legend.box = "vertical", 
        legend.margin = margin(),
        axis.title = element_text(size = 18),
        axis.text = element_text(size = 16),
        title = element_text(size = 20),
        legend.text = element_text(size = 12),
        legend.key = element_rect(size = 11), 
        panel.grid = element_blank()) +
  labs(x = "PC1 (31.26%)",
       y = "PC2 (28.56%)") 
plot_PCA_12_env

adonis2(env_mat ~ site, data = CWM_fixed_filtered, method = "euclidean")
```

# 7. "Tradeoffs"

## pairs plot

```{r}
pairs_plot <- ggpairs(pca_mat_with_cn)
pairs_plot
```

potentially interesting pairs:  

- SAV and thickness (-0.762)  
- thickness and N (-0.749)  
- thickness and C (-0.588)   
- STA and C (0.597)

## summarizing

```{r}
tradeoff_df <- ind_traits %>% 
  filter(sp_code %in% algae_proposal) %>% 
  # filter(!(sp_code %in% c("CO"))) %>% 
  # filter(!(sp_code == "PTCA" & lifestage == "recruit")) %>% 
  # weird Nienburgia?
  filter(!(specimen_ID %in% c("20210721-BULL-023", "20210719-IVEE-009", "20210719-IVEE-010")))

tradeoff_summ <- tradeoff_df %>% 
  group_by(scientific_name) %>% 
  summarize(mean_thickness = mean(thickness_mm_mean, na.rm = TRUE),
            sd_thickness = sd(thickness_mm_mean, na.rm = TRUE), 
            mean_sav = mean(sav_mean, na.rm = TRUE),
            sd_sav = sd(sav_mean, na.rm = TRUE),
            mean_sap = mean(sap_mean, na.rm = TRUE),
            sd_sap = mean(sap_mean, na.rm = TRUE),
            mean_vol = mean(total_volume, na.rm = TRUE),
            sd_vol = sd(total_volume, na.rm = TRUE),
            mean_tdmc = mean(tdmc_mean, na.rm = TRUE),
            sd_tdmc = sd(tdmc_mean, na.rm = TRUE),
            mean_fvfm = mean(fvfm_mean, na.rm = TRUE),
            sd_fvfm = sd(fvfm_mean, na.rm = TRUE),
            mean_c = mean(weight_percent_c_mean, na.rm = TRUE),
            sd_c = sd(weight_percent_c_mean, na.rm = TRUE),
            mean_n = mean(weight_percent_n_mean, na.rm = TRUE),
            sd_n = sd(weight_percent_n_mean, na.rm = TRUE),
            mean_sta = mean(sta_mean, na.rm = TRUE),
            sd_sta = sd(sta_mean, na.rm = TRUE))
```


## a. SAV and thickness

```{r}
thick_sav <- ggplot(tradeoff_summ,
                    aes(x = mean_thickness,
                        y = mean_sav)) +
  geom_errorbarh(aes(xmin = mean_thickness - sd_thickness,
                     xmax = mean_thickness + sd_thickness),
                 alpha = 0.4) +
  geom_errorbar(aes(ymin = mean_sav - sd_sav,
                    ymax = mean_sav + sd_sav),
                alpha = 0.4) +
  geom_point(aes(fill = scientific_name),
             size = 4,
             stroke = 1,
             shape = 21) +
  geom_point(data = ind_traits,
             aes(x = thickness_mm_mean,
                 y = sav_mean,
                 color = scientific_name),
             alpha = 0.2) +
  scale_fill_manual(values = algae_colors) +
  scale_color_manual(values = algae_colors) +
  annotate(geom = "text", x = 1, y = 7500, label = "Spearman ρ = -0.72", size = 10) +
  labs(x = "Mean thickness (mm)",
       y = "Mean surface area:volume ratio (mm \U00B2/mL") +
  theme_bw() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        text = element_text(size = 18))

thick_sav

cor.test(ind_traits$thickness_mm_mean, ind_traits$sav_mean,
         method = "spearman")

# ggsave(here::here("figures", "tradeoffs",
#                   paste("thickness-sav_", today(), ".jpg", sep = "")),
#        thick_sav,
#        width = 8, height = 8, dpi = 150)

```

## b. SAV and SAP

```{r}
sap_sav <- ggplot(tradeoff_summ,
                  aes(x = mean_sap,
                      y = mean_sav)) +
  geom_errorbarh(aes(xmin = mean_sap - sd_sap,
                     xmax = mean_sap + sd_sap),
                 alpha = 0.4) +
  geom_errorbar(aes(ymin = mean_sav - sd_sav,
                    ymax = mean_sav + sd_sav),
                alpha = 0.4) +
  geom_point(aes(fill = scientific_name),
             size = 4,
             stroke = 1,
             shape = 21) +
  geom_point(data = ind_traits,
             aes(x = sap_mean,
                 y = sav_mean,
                 color = scientific_name),
             alpha = 0.2) +
  scale_fill_manual(values = algae_colors) +
  scale_color_manual(values = algae_colors) +
  annotate(geom = "text", x = 60, y = 7500, label = "Spearman ρ = -0.194", size = 10) +
  labs(x = "Mean surface area:perimeter ratio (mm)",
       y = "Mean surface area:volume ratio (mm \U00B2/mL") +
  theme_bw() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        text = element_text(size = 18))

sap_sav

cor.test(ind_traits$sap_mean, ind_traits$sav_mean,
         method = "spearman")

# ggsave(here::here("figures", "tradeoffs",
#                   paste("sap-sav_", today(), ".jpg", sep = "")),
#        sap_sav,
#        width = 8, height = 8, dpi = 150)
```

## c. SAP and total volume

Pearson's r = 0.409

```{r}
sap_vol <- ggplot(tradeoff_summ,
                  aes(x = mean_sap,
                      y = mean_vol)) +
  geom_errorbarh(aes(xmin = mean_sap - sd_sap,
                     xmax = mean_sap + sd_sap),
                 alpha = 0.4) +
  geom_errorbar(aes(ymin = mean_vol - sd_vol,
                    ymax = mean_vol + sd_vol),
                alpha = 0.4) +
  geom_point(aes(fill = scientific_name),
             size = 4,
             stroke = 1,
             shape = 21) +
  geom_point(data = ind_traits %>% filter(specimen_ID != "20220824-MOHK-001"),
             aes(x = sap_mean,
                 y = total_volume,
                 color = scientific_name),
             alpha = 0.2) +
  scale_fill_manual(values = algae_colors) +
  scale_color_manual(values = algae_colors) +
  annotate(geom = "text", x = 60, y = 1000, label = "Spearman ρ = 0.48", size = 10) +
  labs(x = "Mean surface area:perimeter ratio (mm)",
       y = "Mean volume (mL)") +
  theme_bw() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        text = element_text(size = 18))

sap_vol

cor.test(ind_traits$sap_mean, ind_traits$total_volume,
         method = "spearman")

# ggsave(here::here("figures", "tradeoffs",
#                   paste("sap-vol_", today(), ".jpg", sep = "")),
#        sap_vol,
#        width = 8, height = 8, dpi = 150)
```

## d. TDMC and fvfm

Pearson's r = -0.446

```{r}
tdmc_fvfm <- ggplot(tradeoff_summ,
                    aes(x = mean_tdmc,
                        y = mean_fvfm)) +
  geom_errorbarh(aes(xmin = mean_tdmc - sd_tdmc,
                     xmax = mean_tdmc + sd_tdmc),
                 alpha = 0.4) +
  geom_errorbar(aes(ymin = mean_fvfm - sd_fvfm,
                    ymax = mean_fvfm + sd_fvfm),
                alpha = 0.4) +
  geom_point(aes(fill = scientific_name),
             size = 4,
             stroke = 1,
             shape = 21) +
  geom_point(data = ind_traits,
             aes(x = tdmc_mean,
                 y = fvfm_mean,
                 color = scientific_name),
             alpha = 0.2) +
  scale_fill_manual(values = algae_colors) +
  scale_color_manual(values = algae_colors) +
  annotate(geom = "text", x = 0.75, y = 0.8, label = "Spearman ρ = -0.42", size = 10) +
  labs(x = "Mean thallus dry matter content (dry mass:fresh mass)",
       y = "Mean photosynthetic efficiency") +
  theme_bw() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        text = element_text(size = 18))

tdmc_fvfm

cor.test(ind_traits$tdmc_mean, ind_traits$fvfm_mean,
         method = "spearman")

# ggsave(here::here("figures", "tradeoffs",
#                   paste("tdmc-fvfm_", today(), ".jpg", sep = "")),
#        tdmc_fvfm,
#        width = 8, height = 8, dpi = 150)
```

## e. N and STA

```{r}
n_sta <- ggplot(tradeoff_summ,
                    aes(x = mean_n,
                        y = mean_sta)) +
  # geom_errorbarh(aes(xmin = mean_n - sd_n,
  #                    xmax = mean_n + sd_n),
  #                alpha = 0.4) +
  # geom_errorbar(aes(ymin = mean_sta - sd_sta,
  #                   ymax = mean_sta + sd_sta),
  #               alpha = 0.4) +
  geom_point(aes(fill = scientific_name),
             size = 4,
             stroke = 1,
             shape = 21) +
  geom_point(data = ind_traits,
             aes(x = weight_percent_n_mean,
                 y = sta_mean,
                 color = scientific_name),
             alpha = 0.2) +
  scale_fill_manual(values = algae_colors) +
  scale_color_manual(values = algae_colors) +
  # annotate(geom = "text", x = 20, y = 0.8, label = "Spearman ρ = 0.789", size = 10) +
  labs(x = "Mean %C",
       y = "Mean specific thallus area (mm \U00B2/g)") +
  theme_bw() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        text = element_text(size = 18))

n_sta

cor.test(ind_traits$weight_percent_c_mean, ind_traits$fvfm_mean,
         method = "spearman")

# ggsave(here::here("figures", "tradeoffs",
#                   paste("c-fvfm_", today(), ".jpg", sep = "")),
#        c_fvfm,
#        width = 8, height = 8, dpi = 150)
```

# 8. Clustering

Need two data frames:  

1. species x trait for continuous traits  
2. species x trait for categorical traits

## a. getting species x trait matrices

```{r}
cont_spp_mat <- ind_traits %>% 
  filter(sp_code %in% algae_proposal) %>% 
  # filter(!(sp_code %in% c("CO"))) %>% 
  # filter(!(sp_code == "PTCA" & lifestage == "recruit")) %>% 
  # weird Nienburgia?
  filter(!(specimen_ID %in% c("20210721-BULL-023"))) %>% 
  select(scientific_name, maximum_height, total_volume, sav_mean, thickness_mm_mean, tdmc_mean, sta_mean, sav_mean, sap_mean, fvfm_mean, thickness_mm_mean) %>% 
  group_by(scientific_name) %>% 
  mutate(across(c(maximum_height, total_volume, sav_mean, thickness_mm_mean, tdmc_mean, sta_mean, sav_mean, sap_mean, fvfm_mean, thickness_mm_mean), ~mean(., na.rm = TRUE))) %>% 
  unique() %>% 
  column_to_rownames("scientific_name")

cat_spp_mat <- cat_data %>% 
  # all traits
  select(scientific_name,
         size_cm, thickness, position_to_benthos, articulated, stipe,
         midrib, branching, branch_shape, blades, blade_category,
         coenocyte, attachment, tissue_complexity, growth, calcification) %>%
  filter(scientific_name %in% rownames(cont_spp_mat)) %>% 
  column_to_rownames("scientific_name") %>% 
  mutate(across(.cols = thickness:calcification, as_factor))
```

## b. gower dissimilarity matrices

```{r}
cont_gower <- gowdis(cont_spp_mat)
cat_gower <- gowdis(cat_spp_mat)
```

## c. clustering

continuous

```{r}
cont_groups <- cluster::pam(x = cont_gower,
                            k = 3,
                            metric = "euclidean")

pairwise.perm.manova(cont_gower, 
                     fact = cont_groups$clustering, 
                     p.method = "none")

# 4 is too many groups
# groups 1 and 4 are not different from each other
# cont_groups <- cluster::pam(x = cont_gower,
#                             k = 4,
#                             metric = "euclidean")
# 
# pairwise.perm.manova(cont_gower,
#                      fact = cont_groups$clustering,
#                      p.method = "none")
```

categorical

```{r}
cat_groups <- cluster::pam(x = cat_gower,
                            k = 2,
                            metric = "euclidean")

pairwise.perm.manova(cat_gower, 
                     fact = cat_groups$clustering, 
                     p.method = "none")

# 3 is too many groups
# groups 2 and 3 are not different
# cat_groups <- cluster::pam(x = cat_gower,
#                             k = 3,
#                             metric = "euclidean")
# 
# pairwise.perm.manova(cat_gower, 
#                      fact = cat_groups$clustering, 
#                      p.method = "none")
```

getting clusters out

```{r}
cont_clusters <- cont_groups$clustering %>% 
  enframe() %>% 
  rename(cont_cluster = value,
         scientific_name = name) %>% 
  # make sure clusters are factors
  mutate(cont_cluster = factor(cont_cluster)) 

cat_clusters <- cat_groups$clustering %>% 
  enframe() %>% 
  rename(cat_cluster = value,
         scientific_name = name) %>% 
  # make sure clusters are factors
  mutate(cat_cluster = factor(cat_cluster)) 
```


## d. visualizing

```{r}
cont_nmds <- metaMDS(cont_gower) 

cont_nmds_scores <- scores(cont_nmds,
                           choices = c(1, 2),
                           display = c("sites", "species"),
                           tidy = TRUE) %>% 
  as_tibble(rownames = NA) %>% 
  rownames_to_column("scientific_name") %>% 
  mutate(label = case_when(
    scientific_name == "Dictyota binghamiae; Dictyota flabellata; Dictyota coriacea" ~ "Dictyota spp.",
    scientific_name == "Chondracanthus corymbiferus; Chondracanthus exasperatus" ~ "Chondracanthus spp.",
    TRUE ~ scientific_name
  )) %>% 
  left_join(., lte_spp, by = "scientific_name") %>% 
  select(!(life_cycle:eco_zone)) %>% 
  left_join(., cont_clusters, by = "scientific_name") %>% 
  left_join(., cat_clusters, by = "scientific_name")


cont_nmds_plot <- ggplot(cont_nmds_scores,
                          aes(x = NMDS1, y = NMDS2)) +
  geom_point(aes(color = cont_cluster,
                 shape = taxon_phylum), 
             size = 1,
             alpha = 0.9) +
  geom_convexhull(aes(fill = cont_cluster),
                  alpha = 0.6) +
  scale_x_continuous(limits = c(-0.25, 0.25),
                     breaks = c(-0.2, 0, 0.2)) +
  scale_y_continuous(limits = c(-0.25, 0.25),
                     breaks = c(-0.2, 0, 0.2)) +
  scale_color_manual(values = c(cluster1, cluster2, cluster3, cluster4)) +
  scale_fill_manual(values = c(cluster1, cluster2, cluster3, cluster4)) +
  annotate(geom = "text", x = -0.2, y = 0.15, label = "1", color = cluster1, size = 10) +
  annotate(geom = "text", x = -0.1, y = -0.1, label = "2", color = cluster2, size = 10) +
  annotate(geom = "text", x = 0.2, y = -0.2, label = "3", color = cluster3, size = 10) +
  annotate(geom = "text", x = 0.2, y = 0.1, label = "4", color = cluster4, size = 10) +
  labs(title = "PAM clusters with continuous traits") +
  theme_bw() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        text = element_text(size = 16))
  
cont_nmds_plot

cat_nmds_plot <- ggplot(cont_nmds_scores,
                          aes(x = NMDS1, y = NMDS2)) +
  geom_point(aes(color = cat_cluster,
                 shape = taxon_phylum), 
             size = 1,
             alpha = 0.9) +
  geom_convexhull(aes(fill = cat_cluster),
                  alpha = 0.6) +
  scale_x_continuous(limits = c(-0.25, 0.25),
                     breaks = c(-0.2, 0, 0.2)) +
  scale_y_continuous(limits = c(-0.25, 0.25),
                     breaks = c(-0.2, 0, 0.2)) +
  scale_color_manual(values = c(`1` = cat_cluster1, `2` = cat_cluster2)) +
  scale_fill_manual(values = c(`1` = cat_cluster1, `2` = cat_cluster2)) +
  annotate(geom = "text", x = 0.2, y = -0.2, label = "1", color = cat_cluster1, size = 10) +
  annotate(geom = "text", x = -0.2, y = 0, label = "2", color = cat_cluster2, size = 10) +
  labs(title = "PAM clusters with categorical traits") +
  theme_bw() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        text = element_text(size = 12))
  
cat_nmds_plot

# ggsave(here::here("figures", "prelim-ordinations",
#                   paste("cont-nmds-plot_", today(), ".jpg", sep = "")),
#        cont_nmds_plot,
#        width = 6, height = 6, units = "cm", dpi = 300)
# 
# ggsave(here::here("figures", "prelim-ordinations",
#                   paste("cat-nmds-plot_", today(), ".jpg", sep = "")),
#        cat_nmds_plot,
#        width = 6, height = 6, units = "cm", dpi = 300)
```


