---
title: "ordinations"
author: "An Bui"
date: "10/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# source the cleaning/summarizing script, which sources the set up
source(here::here("code", "00_set-up.R"))
```

# 0. Orientation

Necessary data frames are `tbs_matrix` created in the set up script.

# 1. trait PCoA

```{r}
tbs_gower <- tbs_matrix %>% 
  select(2:10) %>% 
  gowdis()
tbs_pcoa <- cmdscale(tbs_gower, eig = TRUE)
# tbs_pcoa <- wcmdscale(tbs_gower, eig = TRUE)
# tbs_pcoa <- ape::pcoa(tbs_gower, correction = "none")
biplot(ape::pcoa(tbs_gower, correction = "none"))
# ordiplot(scores(tbs_pcoa, choices=c(1,2)), type="none", main="PCoA with species weighted averages")
# tbs.wa <- wascores(tbs_pcoa$points[,1:2], tbs_matrix)
# text(tbs.wa, rownames(tbs.wa), cex=0.7, col="red")
# biplot.pcoa(tbs_gower, tbs_pcoa, dir.axis1 = -1)
tbs_pcoa$species <- wascores(tbs_pcoa$points, tbs_matrix[, 2:10], expand = TRUE)
p1 <- ordiplot(tbs_pcoa, type = "none")
points1 <- points(p1, "sites", pch = 21, col = "red", bg = "yellow")
text(p1, "species", col = "blue", cex = 0.9)
# identify(p1, "spec")
```

# 2. PCA

```{r}
sp_int_matrix_test <- ind_traits %>% 
  filter(sp_code %in% algae_proposal) %>% 
  filter(!(sp_code %in% c("CO", "Nandersoniana")))

pca_mat <- sp_int_matrix_test %>% 
  select(specimen_ID, maximum_height, sta_mean, ldmc_mean, sav_mean, sap_mean, fvfm_mean, total_volume, total_dry, thickness_mm_mean) %>% 
  column_to_rownames("specimen_ID") %>% 
  drop_na()
```


```{r}
# tbs matrix filtered for species in proposal
# doesn't include Nienburgia or Corallina
sp_int_matrix <- tbs_matrix %>% 
  filter(sp_code %in% algae_proposal) %>% 
  filter(!(sp_code %in% c("CO", "Nandersoniana")))

filtered_matrix <- tbs_matrix %>% 
  filter(!(sp_code %in% c("MAPY", "CO", "Nandersoniana")))

matrix_choice <- pca_mat

# only include numeric variables
tbs_pca <- rda(matrix_choice[, 2:10], scale = TRUE)
tbs_pca <- rda(pca_mat, scale = TRUE)

# extract proportion explained for each axis
summary(tbs_pca)
tbs_pca$CA
# simple biplot (compare with ggplot output to make sure it's right)
biplot(tbs_pca)

# species points
PCAscores <- scores(tbs_pca, display = "sites", choices = c(1, 2)) %>% 
  as.data.frame() %>% 
  rownames_to_column("specimen_ID") %>% 
  left_join(metadata_ind, by = "specimen_ID") %>% 
  left_join(., coarse_traits, by = "sp_code")

PCAscores_13 <- scores(tbs_pca, display = "sites", choices = c(1, 3)) %>% 
  as.data.frame() %>% 
  rownames_to_column("specimen_ID") %>% 
  left_join(metadata_ind, by = "specimen_ID") %>% 
  left_join(., coarse_traits, by = "sp_code")

# trait vectors
PCAvect <- scores(tbs_pca, display = "species", choices = c(1, 2)) %>% 
  as.data.frame()

PCAvect_13 <- scores(tbs_pca, display = "species", choices = c(1, 3)) %>% 
  as.data.frame()

# plot PCA
plot_PCA_12 <- ggplot() +
  coord_cartesian() +
  geom_point(data = PCAscores, aes(x = PC1, y = PC2, color = scientific_name, shape = site), size = 2) +
  # geom_text(data = PCAscores, aes(x = PC1, y = PC2, color = scientific_name, label = specimen_ID)) +
  # scale_color_manual(values = pal) +
  geom_vline(xintercept = c(0), color = "grey70", linetype = 2) +
  geom_hline(yintercept = c(0), color = "grey70", linetype = 2) +
  geom_segment(data = PCAvect, aes(x = 0, y = 0, xend = PC1, yend = PC2), arrow = arrow(length = unit(0.2, "cm"))) +
  geom_text(data = PCAvect, aes(x = PC1, y = PC2, label = rownames(PCAvect))) +
  theme_bw() +
  guides(colour = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom", 
        legend.box = "vertical", 
        legend.margin = margin(),
        axis.title = element_text(size = 12)) +
  labs(x = "PC1 (49.61%)",
       y = "PC2 (25.21%)",
       title = "Principal Components Analysis - PC1 and PC2",
       subtitle = "Species in proposal", 
       color = "Scientific name") 
plot_PCA_12

plot_PCA_13 <- ggplot() +
  coord_cartesian() +
  geom_point(data = PCAscores_13, aes(x = PC1, y = PC3, color = scientific_name, shape = site), size = 2) +
  # geom_text(data = PCAscores, aes(x = PC1, y = PC2, color = scientific_name, label = specimen_ID)) +
  # scale_color_manual(values = pal) +
  geom_vline(xintercept = c(0), color = "grey70", linetype = 2) +
  geom_hline(yintercept = c(0), color = "grey70", linetype = 2) +
  geom_segment(data = PCAvect_13, aes(x = 0, y = 0, xend = PC1, yend = PC3), arrow = arrow(length = unit(0.2, "cm"))) +
  geom_text(data = PCAvect_13, aes(x = PC1, y = PC3, label = rownames(PCAvect))) +
  theme_bw() +
  guides(colour = guide_legend(ncol = 2)) +
  theme(legend.position = "bottom", 
        legend.box = "vertical", 
        legend.margin = margin(),
        axis.title = element_text(size = 12)) +
  labs(x = "PC1 (52.65%)",
       y = "PC3 (9.78%)",
       title = "Principal Components Analysis - PC1 and PC3",
       subtitle = "Species in proposal", 
       color = "Scientific name") 
plot_PCA_13

# ggsave(here::here("figures/prelim-ordinations",
#                   paste("PCA_spp-all-12", todays_date, ".jpg", sep = "")),
#        plot_PCA_12,
#        width = 8, height = 8, dpi = 150)
# 
# ggsave(here::here("figures/prelim-ordinations",
#                   paste("PCA_spp-all-13", todays_date, ".jpg", sep = "")),
#        plot_PCA_13,
#        width = 8, height = 8, dpi = 150)
```

# 3. Corrplot

```{r}
M <- sp_int_matrix[, 2:10] %>% 
  # take out variables with NAs
  # select(-growth_form, -pigment_type) %>% 
  # take out UV
  # slice(-16) %>% 
  cor()

M <- pca_mat %>% 
  cor()

corr_traits <- corrplot(M, method = "circle", type = "lower", insig = "blank", addCoef.col = "black")
```
