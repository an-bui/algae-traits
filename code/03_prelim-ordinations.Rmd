---
title: "ordinations"
author: "An Bui"
date: "10/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# source the cleaning/summarizing script, which sources the set up
source(here::here("code", "00_set-up.R"))
```

# 0. Orientation

Necessary data frames are `tbs_matrix` created in the set up script.

# 1. trait PCoA

```{r}
tbs_gower <- tbs_matrix %>% 
  select(2:13) %>% 
  gowdis()
tbs_pcoa <- cmdscale(tbs_gower, eig = TRUE)
# tbs_pcoa <- wcmdscale(tbs_gower, eig = TRUE)
# tbs_pcoa <- ape::pcoa(tbs_gower, correction = "none")
biplot(ape::pcoa(tbs_gower, correction = "none"))
# ordiplot(scores(tbs_pcoa, choices=c(1,2)), type="none", main="PCoA with species weighted averages")
# tbs.wa <- wascores(tbs_pcoa$points[,1:2], tbs_matrix)
# text(tbs.wa, rownames(tbs.wa), cex=0.7, col="red")
# biplot.pcoa(tbs_gower, tbs_pcoa, dir.axis1 = -1)
tbs_pcoa$species <- wascores(tbs_pcoa$points, tbs_matrix[, 2:13], expand = TRUE)
p1 <- ordiplot(tbs_pcoa, type = "none")
points1 <- points(p1, "sites", pch = 21, col = "red", bg = "yellow")
text(p1, "species", col = "blue", cex = 0.9)
# identify(p1, "spec")
```

# 2. PCA

2022-03-14: none of this seems right? Some scaling needs to happen...

```{r}
# only include numeric variables
tbs_pca <- rda(tbs_matrix[, 2:13])

# extract proportion explained for each axis
summary(tbs_pca)

# simple biplot (compare with ggplot output to make sure it's right)
biplot(tbs_pca)

# species points
PCAscores <- scores(tbs_pca, display = "sites") %>% 
  as.data.frame() %>% 
  rownames_to_column("specimen_ID") %>% 
  left_join(metadata_subsamples, by = "specimen_ID") %>% 
  left_join(., coarse_traits, by = "sp_code")

# trait vectors
PCAvect <- scores(tbs_pca, display = "species") %>% 
  as.data.frame()

# plot PCA
plot_PCA <- ggplot() +
  geom_point(data = PCAscores, aes(x = PC1, y = PC2, color = scientific_name)) +
  # scale_color_manual(values = pal) +
  geom_vline(xintercept = c(0), color = "grey70", linetype = 2) +
  geom_hline(yintercept = c(0), color = "grey70", linetype = 2) +
  geom_segment(data = PCAvect, aes(x = 0, y = 0, xend = PC1, yend = PC2), arrow = arrow(length = unit(0.2, "cm"))) +
  geom_text(data = PCAvect, aes(x = PC1, y = PC2, label = rownames(PCAvect))) +
  theme_bw() +
  guides(colour = guide_legend(nrow = 5)) +
  theme(legend.position = "bottom", legend.box = "vertical", legend.margin = margin()) +
  labs(x = "PC1 (98.67%)",
       y = "PC2 (1.33%)",
       title = "Principal Components Analysis",
       color = "Scientific name") 
plot_PCA

# ggsave(here::here("figures/prelim-ordinations",
#                   paste("PCA_spp-", todays_date, ".jpg", sep = "")),
#        plot_PCA,
#        width = 8, height = 8, dpi = 150)
```

# 3. Corrplot

```{r}
M <- tbs_matrix[, 2:13] %>% 
  # take out variables with NAs
  # select(-growth_form, -pigment_type) %>% 
  # take out UV
  # slice(-16) %>% 
  cor()

corr_traits <- corrplot(M, method = "circle", type = "lower")

# ggsave(here::here("figures/prelim-ordinations",
#                   paste("corrplot_traits-", todays_date, ".jpg", sep = "")),
#        corr_traits,
#        width = 8, height = 8, dpi = 150)
```
